# ğŸ“‹ **TurnoFarm - DocumentaciÃ³n Completa del Proyecto**

## ğŸ¯ **DescripciÃ³n General**
AplicaciÃ³n iOS nativa (Swift) para encontrar farmacias de turno en Chile. Permite localizar al usuario y mostrar farmacias cercanas ordenadas por distancia, con detalles completos e integraciÃ³n con apps de mapas.

---

## ğŸ—ï¸ **Arquitectura del Proyecto**

### **Estructura de Archivos**
```
TurnoFarm/
â”œâ”€â”€ Model/
â”‚   â”œâ”€â”€ Pharmacy.swift          # Modelo principal de farmacia
â”‚   â”œâ”€â”€ PharmacyData.swift      # Modelo para API response
â”‚   â””â”€â”€ FinderManager.swift     # Manager para API calls
â”œâ”€â”€ View/
â”‚   â”œâ”€â”€ Main.storyboard         # UI principal
â”‚   â”œâ”€â”€ LaunchScreen.storyboard # Splash screen
â”‚   â”œâ”€â”€ PharmacyCell.swift/.xib # Celda custom para lista
â”‚   â””â”€â”€ DetailFieldView/        # Componentes de detalle
â”‚       â”œâ”€â”€ DetailFieldView.swift/.xib
â”‚       â”œâ”€â”€ DetailFieldStrategy.swift
â”‚       â”œâ”€â”€ NormalFieldStrategy.swift
â”‚       â”œâ”€â”€ PhoneFieldStrategy.swift
â”‚       â””â”€â”€ AddressFieldStrategy.swift
â”œâ”€â”€ Controller/
â”‚   â”œâ”€â”€ FinderViewController.swift  # Pantalla principal
â”‚   â””â”€â”€ DetailViewController.swift  # Pantalla de detalles
â”œâ”€â”€ Assets.xcassets/            # ImÃ¡genes y colores
â”œâ”€â”€ Constants.swift             # Constantes de la app
â”œâ”€â”€ AppDelegate.swift           # Entry point
â”œâ”€â”€ SceneDelegate.swift         # Scene lifecycle
â””â”€â”€ Info.plist                 # Configuraciones
```

---

## ğŸ“± **Funcionalidades Principales**

### **1. Pantalla Principal (FinderViewController)**

#### **GeolocalizaciÃ³n**
- **Permiso de ubicaciÃ³n**: Solicita automÃ¡ticamente al abrir
- **Mi UbicaciÃ³n**: BotÃ³n para re-localizar usuario
- **Manejo de errores**: Si falla GPS, permite bÃºsqueda manual

#### **BÃºsqueda de Ubicaciones**
- **Autocompletado**: Usa `MKLocalSearchCompleter`
- **Filtro Chile**: Solo muestra resultados de Chile
- **BÃºsqueda manual**: TextField con resultados desplegables
- **RegiÃ³n especÃ­fica**: Configurado para territorio chileno

#### **Lista de Farmacias**
- **Ordenamiento**: Por distancia (mÃ¡s cercana primero)
- **InformaciÃ³n mostrada**:
  - Distancia en kilÃ³metros
  - Nombre de la farmacia
  - DirecciÃ³n completa (direcciÃ³n + localidad)
- **Celda personalizada**: `PharmacyCell` con layout especÃ­fico

#### **Radio de BÃºsqueda**
- **LÃ­mite**: 50km desde ubicaciÃ³n
- **Filtrado automÃ¡tico**: Solo muestra farmacias dentro del radio

### **2. Pantalla de Detalles (DetailViewController)**

#### **InformaciÃ³n Completa**
- **Nombre**: Nombre de la farmacia
- **TelÃ©fono**: Con detector de datos (clickeable)
- **DirecciÃ³n**: Con detector de direcciones (clickeable)
- **Horarios**: Texto descriptivo del turno

#### **Mapa Integrado**
- **MapKit**: Mapa nativo de Apple
- **UbicaciÃ³n farmacia**: Pin en ubicaciÃ³n exacta
- **Ruta**: Si hay ubicaciÃ³n del usuario, muestra ruta en auto
- **Tiempo estimado**: Calcula y muestra tiempo de viaje
- **Callout**: InformaciÃ³n emergente en el pin

#### **IntegraciÃ³n con Apps Externas**
Al tocar el mapa, ActionSheet con opciones:
- **Apple Maps**: Abre ubicaciÃ³n en Maps nativo
- **Google Maps**: Abre en Google Maps (si estÃ¡ instalado)
- **Waze**: Abre en Waze (si estÃ¡ instalado)
- **Manejo de errores**: Avisa si app no estÃ¡ instalada

### **3. Componentes Personalizados**

#### **DetailFieldView (PatrÃ³n Strategy)**
- **NormalFieldStrategy**: Campo de solo lectura
- **PhoneFieldStrategy**: Detecta telÃ©fonos, permite llamar
- **AddressFieldStrategy**: Detecta direcciones, abre en mapas
- **ConfiguraciÃ³n dinÃ¡mica**: Cada campo se configura segÃºn su tipo

---

## ğŸŒ **IntegraciÃ³n con API**

### **Endpoint**
```
URL: https://midas.minsal.cl/farmacia_v2/WS/getLocalesTurnos.php
MÃ©todo: GET
```

### **Rate Limiting Inteligente**
- **Cache local**: 4 horas entre requests
- **UserDefaults**: Guarda Ãºltima respuesta y timestamp
- **ReutilizaciÃ³n**: Si hay datos recientes, los usa sin hacer request

### **Modelo de Datos**
```swift
struct PharmacyData: Codable {
    let fecha: String
    let local_id: String
    let local_nombre: String
    let comuna_nombre: String
    let localidad_nombre: String
    let local_direccion: String
    let funcionamiento_hora_apertura: String
    let funcionamiento_hora_cierre: String
    let local_telefono: String
    let local_lat: String
    let local_lng: String
    let funcionamiento_dia: String
}

struct Pharmacy: Codable {
    let id: String
    let name: String
    let address: String
    let district: String
    let city: String
    let phone: String
    let latitude: Double
    let longitude: Double
    let openingHour: String
    let closingHour: String
    let functioningDay: String
    var distanceFromUser: Double?
    var fullAddress: String
}
```

### **CorrecciÃ³n de Coordenadas**
- **ValidaciÃ³n**: Verifica coordenadas estÃ¡n dentro de Chile
- **NormalizaciÃ³n**: Divide por 1,000,000 si estÃ¡n en formato incorrecto
- **Fallback**: Santiago como coordenadas por defecto (-33.45, -70.6667)

---

## ğŸ¨ **DiseÃ±o y UI**

### **Colores Personalizados**
- **TurnoBlue**: Color principal de la app
- **TurnoRed**: Color de acento
- **Soporte Dark Mode**: Variantes para modo oscuro

### **Layout**
- **Responsive**: Funciona en iPhone y iPad
- **Auto Layout**: Constraints para diferentes tamaÃ±os
- **Stack Views**: OrganizaciÃ³n limpia de componentes

### **IconografÃ­a**
- **SF Symbols**: Iconos nativos de Apple
- **location.circle.fill**: BotÃ³n de ubicaciÃ³n
- **magnifyingglass**: BotÃ³n de bÃºsqueda

---

## ğŸ”§ **Configuraciones TÃ©cnicas**

### **Permisos (Info.plist)**
```xml
<key>NSLocationWhenInUseUsageDescription</key>
<string>Necesitamos tu ubicaciÃ³n para encontrar la farmacia mÃ¡s cercana</string>

<key>LSApplicationQueriesSchemes</key>
<array>
    <string>comgooglemaps</string>
    <string>waze</string>
</array>
```

### **Deployment Target**
- **iOS 13.0+**: VersiÃ³n mÃ­nima soportada
- **Swift 5.0**: Lenguaje de programaciÃ³n
- **Xcode 15.3**: VersiÃ³n de desarrollo

### **Bundle Identifier**
`com.flarenaster.TurnoFarm`

---

## ğŸ”„ **Flujo de Usuario**

### **Flujo Principal**
1. **App Launch** â†’ Solicita permisos de ubicaciÃ³n
2. **GeolocalizaciÃ³n** â†’ Obtiene coordenadas del usuario
3. **API Call** â†’ Consulta farmacias (con rate limiting)
4. **Filtrado** â†’ Muestra solo farmacias dentro de 50km
5. **Lista** â†’ Ordena por distancia y muestra
6. **SelecciÃ³n** â†’ Usuario toca farmacia
7. **Detalles** â†’ Muestra informaciÃ³n completa + mapa
8. **NavegaciÃ³n** â†’ Usuario puede abrir en apps externas

### **Flujo de BÃºsqueda Manual**
1. **Usuario escribe** â†’ Autocompletado se activa
2. **Filtro Chile** â†’ Solo resultados chilenos
3. **SelecciÃ³n lugar** â†’ Usa coordenadas del lugar
4. **API Call** â†’ Busca farmacias cerca del lugar
5. **Lista actualizada** â†’ Muestra farmacias cercanas al lugar

---

## ğŸš€ **Features TÃ©cnicos Avanzados**

### **Manejo de Estados**
- **Delegate Pattern**: FinderManagerDelegate para callbacks
- **Error Handling**: Manejo robusto de errores de red/GPS
- **Loading States**: Indicadores de carga apropiados

### **Performance**
- **Lazy Loading**: Celdas reutilizables en tabla
- **Memory Management**: Weak references para evitar retain cycles
- **Efficient Rendering**: Solo renderiza celdas visibles

### **Experiencia de Usuario**
- **Smooth Animations**: Transiciones nativas
- **Haptic Feedback**: (Implementable)
- **Accessibility**: Labels apropiados para VoiceOver
- **Offline Tolerance**: Cache de Ãºltima bÃºsqueda

---

## ğŸ¯ **Casos de Uso EspecÃ­ficos**

### **Usuario en Santiago**
1. Abre app â†’ GPS automÃ¡tico â†’ Ve farmacias cercanas
2. Selecciona una â†’ Ve detalles + tiempo de viaje
3. Toca mapa â†’ Abre en Waze para navegar

### **Usuario viajando**
1. Abre app â†’ No reconoce ubicaciÃ³n
2. Busca "ValparaÃ­so" â†’ Selecciona de autocompletado
3. Ve farmacias de ValparaÃ­so â†’ Selecciona una
4. Llama directamente desde el telÃ©fono mostrado

### **Usuario sin GPS**
1. App falla GPS â†’ Permite bÃºsqueda manual
2. Escribe ubicaciÃ³n â†’ Encuentra farmacias
3. Funcionalidad completa sin ubicaciÃ³n propia

---

## ğŸ“Š **MÃ©tricas y Limitaciones**

### **Limitaciones Actuales**
- **iOS Only**: No hay versiÃ³n Android
- **Chile Only**: API y filtros especÃ­ficos para Chile
- **Rate Limit**: 1 request cada 4 horas
- **Radius**: MÃ¡ximo 50km de bÃºsqueda

### **Performance Targets**
- **App Launch**: < 3 segundos hasta lista
- **GPS Fix**: < 10 segundos en condiciones normales
- **API Response**: TÃ­picamente < 5 segundos
- **Map Rendering**: InstantÃ¡neo con datos cached

---

Esta documentaciÃ³n cubre todas las funcionalidades, arquitectura y detalles tÃ©cnicos del proyecto original TurnoFarm en Swift/iOS.